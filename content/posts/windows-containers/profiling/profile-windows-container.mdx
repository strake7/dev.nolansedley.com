---
title: Profiling Memory for a .NET application running in a Windows Docker Container 
date: 2021-05-02
image: ./top1.png
imageAlt: screenshot of kubectl
---
Recently at Mindbody, we have made a push to containerize and ship these applications to a Cloud provider. Some older applications are still based in .NET Framework. AS such we needed to run these in [Windows Container Images](https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/container-base-images). Once we got through the hoops of running our applications in a container we found that the memory usage was unexpectedly high. Unfortunately, the instrumentation surround windows docker containers is not a first-class citizen yet. In the meantime your may find yourself needing to 
Windows docker containers? Sometimes, you do what you got to do. 
Running a memory profiler on your windows container.

1. Ensure your kubectl is setup and you are able to list the target pods. Shell into the pod you are wanting to profile:
   > kubectl exec -it somepod-abc-123 -n my-namespace powershell

2. Check out the memory allocation per process on the pod:
    > get-process | Group-Object -Property ProcessName | Format-Table Name, @{n='Mem (KB)';e={'{0:N0}' -f (($_.Group|Measure-Object WorkingSet64 -Sum).Sum / 1KB)};a='right'} -AutoSize

3. Download your standalone profiler of choice. For me, I recommend [JetBrains DotMemory](https://www.jetbrains.com/help/dotmemory/Profile_ASP_Web_Site.html#profiling-via-console-tools). Copy an archive of these tools to your pod:
    > kubectl cp '.\dotmemory.zip' somepod-abc-123:/PerformanceTools.zip -n my-namespace 

4. Extract the archive contents
    > Expand-Archive .\dotmemory.zip

2. Run the profiler and target the high memory process. In my case, I was aiming to profile the w3wp.exe process


Note: In the event that receive an error indicating a profiler is already attached, you will need to disable that exisitng profiler and restart IIS. For me, the .NET NewRelic agent was already attached and as such I needed to disable the agent via configuration and restart IIS. 

3. Copy the snapshot output back to your local machine and view the results
   >kubectl cp mindbody-api-affiliate-canary-558f5968c4-8s6ch:/snapshots /snapshots -n mindbody-api-affiliate



Check your 